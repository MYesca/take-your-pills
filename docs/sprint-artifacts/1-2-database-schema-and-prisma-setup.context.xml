<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.2</storyId>
    <title>Database Schema and Prisma Setup</title>
    <status>drafted</status>
    <generatedAt>2025-11-19</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-2-database-schema-and-prisma-setup.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>the database schema defined with Prisma and migrations set up</iWant>
    <soThat>medication data can be stored and queried efficiently</soThat>
    <tasks>
      <task id="1" ac="1">
        <title>Initialize Prisma</title>
        <subtasks>
          <subtask>Run `npx prisma init` in the project root</subtask>
          <subtask>Verify `prisma/schema.prisma` file is created</subtask>
          <subtask>Verify PostgreSQL datasource is configured</subtask>
          <subtask>Verify DATABASE_URL is added to `.env.example` template</subtask>
          <subtask>Update `.env.local` with actual DATABASE_URL (required before migration)</subtask>
        </subtasks>
      </task>
      <task id="2" ac="2">
        <title>Define Database Schema</title>
        <subtasks>
          <subtask>Define User model with all required fields and relationships</subtask>
          <subtask>Define Medication model with all required fields and relationships</subtask>
          <subtask>Define ConsumptionHistory model with all required fields and relationships</subtask>
          <subtask>Add unique constraints (user_id + medication name, medication_id + scheduled_time)</subtask>
          <subtask>Add indexes for efficient queries (user_id, medication_id, scheduled_time)</subtask>
          <subtask>Verify all relationships use CASCADE deletes where appropriate</subtask>
          <subtask>Verify all date/time fields use TIMESTAMP WITH TIME ZONE</subtask>
          <subtask>Verify all primary keys use UUID</subtask>
        </subtasks>
      </task>
      <task id="3" ac="3">
        <title>Create Initial Migration</title>
        <subtasks>
          <subtask>Run `npx prisma migrate dev --name init`</subtask>
          <subtask>Verify migration file is created in `prisma/migrations/`</subtask>
          <subtask>Verify database tables are created in external PostgreSQL server (users, medications, consumption_history)</subtask>
          <subtask>Verify Prisma Client is automatically generated</subtask>
        </subtasks>
      </task>
      <task id="4" ac="4">
        <title>Generate Prisma Client</title>
        <subtasks>
          <subtask>Run `npx prisma generate`</subtask>
          <subtask>Verify Prisma Client is generated in `node_modules/.prisma/client`</subtask>
          <subtask>Verify Prisma Client can be imported: `import { PrismaClient } from '@prisma/client'`</subtask>
        </subtasks>
      </task>
      <task id="5" ac="5">
        <title>Create Prisma Client Singleton</title>
        <subtasks>
          <subtask>Create `lib/prisma/client.ts` file</subtask>
          <subtask>Implement singleton pattern to prevent multiple Prisma Client instances</subtask>
          <subtask>Export Prisma Client instance for use across application</subtask>
          <subtask>Verify singleton pattern works correctly (requires DATABASE_URL to test)</subtask>
        </subtasks>
      </task>
      <task id="6" ac="6">
        <title>Verify Prisma Studio</title>
        <subtasks>
          <subtask>Run `npx prisma studio`</subtask>
          <subtask>Verify Prisma Studio opens in browser</subtask>
          <subtask>Verify all tables are visible (users, medications, consumption_history)</subtask>
          <subtask>Verify schema relationships are correctly displayed</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC1">
      <description>Given the project is initialized, when I run `npx prisma init`, then Prisma is configured with: `prisma/schema.prisma` file created, PostgreSQL datasource configured, DATABASE_URL environment variable template</description>
    </criterion>
    <criterion id="AC2">
      <description>When I define the Prisma schema, then the schema includes: User model with id, externalId, email, timezone, timestamps; Medication model with id, userId, name, cronExpression, timestamps; ConsumptionHistory model with id, medicationId, userId, scheduledTime, consumedAt, timestamps; All relationships defined (User → Medications, User → ConsumptionHistory, Medication → ConsumptionHistory); Unique constraints defined (user_id + medication name, medication_id + scheduled_time); Indexes defined for efficient queries (user_id, medication_id, scheduled_time)</description>
    </criterion>
    <criterion id="AC3">
      <description>When I run `npx prisma migrate dev --name init`, then: Initial migration is created, Database tables are created in external PostgreSQL server, Prisma Client is generated</description>
    </criterion>
    <criterion id="AC4">
      <description>When I run `npx prisma generate`, then Prisma Client is generated and can be imported successfully</description>
    </criterion>
    <criterion id="AC5">
      <description>When I create `lib/prisma/client.ts` with singleton pattern, then Prisma Client instance is accessible across the application</description>
    </criterion>
    <criterion id="AC6">
      <description>When I run `npx prisma studio`, then I can view and interact with the database schema</description>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>TakeYourPills - Architecture</title>
        <section>Database Schema</section>
        <snippet>Database: PostgreSQL 15+. Tables: users (id UUID, external_id VARCHAR(255) UNIQUE, email VARCHAR(255), timezone VARCHAR(50) DEFAULT 'UTC', timestamps), medications (id UUID, user_id UUID REFERENCES users, name VARCHAR(255), cron_expression VARCHAR(255), timestamps, UNIQUE(user_id, name)), consumption_history (id UUID, medication_id UUID REFERENCES medications, user_id UUID REFERENCES users, scheduled_time TIMESTAMP WITH TIME ZONE, consumed_at TIMESTAMP WITH TIME ZONE, timestamps, UNIQUE(medication_id, scheduled_time)). Indexes: users(external_id), medications(user_id, user_id+created_at), consumption_history(user_id, medication_id, scheduled_time, user_id+scheduled_time).</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>TakeYourPills - Architecture</title>
        <section>Prisma Schema</section>
        <snippet>Prisma schema includes User, Medication, and ConsumptionHistory models. User model: id UUID, externalId unique, email, timezone default UTC, relationships to medications and consumptionHistory. Medication model: id UUID, userId foreign key, name, cronExpression, unique constraint on (userId, name), indexes on userId and (userId, createdAt). ConsumptionHistory model: id UUID, medicationId and userId foreign keys, scheduledTime and consumedAt (both UTC), unique constraint on (medicationId, scheduledTime), indexes on userId, medicationId, scheduledTime, and (userId, scheduledTime). All relationships use CASCADE deletes.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>TakeYourPills - Architecture</title>
        <section>ADR-002: PostgreSQL + Prisma for Data Persistence</section>
        <snippet>Decision: Use PostgreSQL with Prisma ORM. Context: Structured medication data, time-based queries, need for ACID guarantees. Consequences: Strong type safety with Prisma, excellent for time-based queries, ACID guarantees for healthcare data, migration system built-in. Requires managed PostgreSQL hosting.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>TakeYourPills - Architecture</title>
        <section>Data Architecture</section>
        <snippet>Data Relationships: users 1:N medications (one user has many medications), medications 1:N consumption_history (one medication has many consumption records), users 1:N consumption_history (one user has many consumption records). Data Isolation: All queries MUST filter by user_id to enforce data isolation. Foreign key constraints ensure referential integrity. CASCADE deletes: Deleting user deletes all their medications and consumption history.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>TakeYourPills - Architecture</title>
        <section>Date/Time Handling</section>
        <snippet>Storage: All dates/times stored in UTC (ISO 8601 format: YYYY-MM-DDTHH:mm:ss.sssZ). Display: Convert to user's timezone preference using date-fns-tz. Format Standards: API: ISO 8601 strings (UTC), Database: TIMESTAMP WITH TIME ZONE (PostgreSQL), Frontend display: Format based on user's locale and timezone preference. Library: date-fns + date-fns-tz for all date operations.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/epic-1-context.md</path>
        <title>Epic Technical Specification: Foundation & Project Setup</title>
        <section>Story 1.2 Implementation Steps</section>
        <snippet>Step-by-step implementation: 1) Initialize Prisma with `npx prisma init`, 2) Configure DATABASE_URL in .env with external PostgreSQL connection string, 3) Define Prisma schema with User, Medication, ConsumptionHistory models following architecture document exactly, 4) Create initial migration with `npx prisma migrate dev --name init`, 5) Generate Prisma Client with `npx prisma generate`, 6) Create Prisma Client singleton in `lib/prisma/client.ts`, 7) Verify database setup with `npx prisma studio`.</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/epic-1-context.md</path>
        <title>Epic Technical Specification: Foundation & Project Setup</title>
        <section>Data Models and Contracts</section>
        <snippet>Prisma Schema Models: User (id UUID, externalId unique, email, timezone default UTC, timestamps, relationships to medications and consumptionHistory), Medication (id UUID, userId foreign key, name, cronExpression, timestamps, unique constraint on userId+name, indexes on userId and userId+createdAt), ConsumptionHistory (id UUID, medicationId and userId foreign keys, scheduledTime UTC, consumedAt UTC, timestamps, unique constraint on medicationId+scheduledTime, indexes on userId, medicationId, scheduledTime, userId+scheduledTime). All relationships use CASCADE deletes. All times stored in UTC using TIMESTAMP WITH TIME ZONE.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>TakeYourPills - Epics and Stories</title>
        <section>Story 1.2: Database Schema and Prisma Setup</section>
        <snippet>User story: As a developer, I want the database schema defined with Prisma and migrations set up, So that medication data can be stored and queried efficiently. Acceptance criteria include Prisma initialization, schema definition with all models and relationships, initial migration creation, Prisma Client generation, and singleton pattern implementation.</snippet>
      </doc>
      <doc>
        <path>docs/prd.md</path>
        <title>TakeYourPills - Product Requirements Document</title>
        <section>Project Classification</section>
        <snippet>Technical Type: web_app. Single Page Application (SPA) accessible via web browsers. Responsive design for desktop and mobile browsers. Real-time medication tracking interface. Browser-based application (no native mobile app in MVP).</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>takeyourpills/prisma/schema.prisma</path>
        <type>schema</type>
        <description>Prisma schema file defining User, Medication, and ConsumptionHistory models with all relationships, constraints, and indexes</description>
        <snippet>generator client { provider = "prisma-client-js" }
datasource db { provider = "postgresql" }
model User { id String @id @default(uuid()), externalId String @unique @map("external_id"), email String, timezone String @default("UTC"), createdAt DateTime @default(now()), updatedAt DateTime @updatedAt, medications Medication[], consumptionHistory ConsumptionHistory[], @@map("users"), @@index([externalId]) }
model Medication { id String @id @default(uuid()), userId String @map("user_id"), name String, cronExpression String @map("cron_expression"), createdAt DateTime @default(now()), updatedAt DateTime @updatedAt, user User @relation(fields: [userId], references: [id], onDelete: Cascade), consumptionHistory ConsumptionHistory[], @@unique([userId, name]), @@map("medications"), @@index([userId]), @@index([userId, createdAt]) }
model ConsumptionHistory { id String @id @default(uuid()), medicationId String @map("medication_id"), userId String @map("user_id"), scheduledTime DateTime @map("scheduled_time"), consumedAt DateTime @map("consumed_at"), createdAt DateTime @default(now()), medication Medication @relation(fields: [medicationId], references: [id], onDelete: Cascade), user User @relation(fields: [userId], references: [id], onDelete: Cascade), @@unique([medicationId, scheduledTime]), @@map("consumption_history"), @@index([userId]), @@index([medicationId]), @@index([scheduledTime]), @@index([userId, scheduledTime]) }</snippet>
      </artifact>
      <artifact>
        <path>takeyourpills/lib/prisma/client.ts</path>
        <type>implementation</type>
        <description>Prisma Client singleton pattern implementation to prevent multiple instances in serverless environments</description>
        <snippet>import { PrismaClient } from '@prisma/client'
const globalForPrisma = globalThis as unknown as { prisma: PrismaClient | undefined }
function createPrismaClient() { return new PrismaClient({ log: process.env.NODE_ENV === 'development' ? ['query', 'error', 'warn'] : ['error'] }) }
function getPrismaClient(): PrismaClient { if (!globalForPrisma.prisma) { globalForPrisma.prisma = createPrismaClient() } return globalForPrisma.prisma }
export const prisma = new Proxy({} as PrismaClient, { get(_target, prop) { const client = getPrismaClient(); const value = (client as any)[prop]; if (typeof value === 'function') { return value.bind(client) } return value } })</snippet>
      </artifact>
    </code>
    <dependencies>
      <ecosystem name="node">
        <package name="@prisma/client" version="latest" />
        <package name="prisma" version="latest" />
        <package name="pg" version="latest" />
      </ecosystem>
      <ecosystem name="database">
        <package name="postgresql" version="15+" />
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>
      <type>Architecture</type>
      <description>Database must be external PostgreSQL server (not local SQLite) for local development</description>
      <source>docs/architecture.md#Database-Choice</source>
    </constraint>
    <constraint>
      <type>Architecture</type>
      <description>ORM must be Prisma for type-safe database access</description>
      <source>docs/architecture.md#ADR-002</source>
    </constraint>
    <constraint>
      <type>Data Model</type>
      <description>All primary keys must use UUID format</description>
      <source>docs/sprint-artifacts/epic-1-context.md#Data-Models</source>
    </constraint>
    <constraint>
      <type>Data Model</type>
      <description>All dates/times must be stored in UTC using TIMESTAMP WITH TIME ZONE</description>
      <source>docs/architecture.md#Timezone-Handling</source>
    </constraint>
    <constraint>
      <type>Security</type>
      <description>All queries must filter by user_id for data isolation</description>
      <source>docs/architecture.md#Security-Patterns</source>
    </constraint>
    <constraint>
      <type>Data Model</type>
      <description>Referential integrity: CASCADE deletes for related records</description>
      <source>docs/sprint-artifacts/epic-1-context.md#Data-Models</source>
    </constraint>
    <constraint>
      <type>Naming</type>
      <description>Database tables must use snake_case (users, medications, consumption_history)</description>
      <source>docs/architecture.md#Naming-Conventions</source>
    </constraint>
    <constraint>
      <type>Naming</type>
      <description>Model names must use PascalCase (User, Medication, ConsumptionHistory)</description>
      <source>Prisma conventions</source>
    </constraint>
    <constraint>
      <type>Naming</type>
      <description>Field names use camelCase in schema, snake_case in database via @map directives</description>
      <source>docs/architecture.md#Naming-Conventions</source>
    </constraint>
    <constraint>
      <type>Project Structure</type>
      <description>Prisma schema must be in prisma/ directory</description>
      <source>docs/architecture.md#Project-Structure</source>
    </constraint>
    <constraint>
      <type>Project Structure</type>
      <description>Prisma Client singleton must be in lib/prisma/ directory</description>
      <source>docs/architecture.md#Project-Structure</source>
    </constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>PrismaClient</name>
      <type>ORM Client</type>
      <description>Prisma Client instance exported from lib/prisma/client.ts. Singleton pattern prevents multiple instances. Used for all database operations across the application.</description>
      <usage>Import: `import { prisma } from '@/lib/prisma/client'`. Usage: `await prisma.user.findMany({ where: { userId: authenticatedUserId } })`</usage>
      <location>lib/prisma/client.ts</location>
    </interface>
    <interface>
      <name>Database Connection</name>
      <type>External Service</type>
      <description>External PostgreSQL server connection via DATABASE_URL environment variable. Format: `postgresql://user:password@host:port/database`</description>
      <usage>Configured in .env.local (not committed). Used by Prisma Client for all database operations.</usage>
      <location>Environment variable: DATABASE_URL</location>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Schema Validation: Prisma validates schema syntax automatically when running `npx prisma validate` or `npx prisma migrate dev`. Migration Testing: Verify migrations can be applied and rolled back. Client Testing: Verify Prisma Client can be imported and used (deferred to later stories when API routes are created). Testing Framework: Vitest (configured in Story 1.4) for unit and integration tests. Test Database: Use separate test database (different DATABASE_URL for tests) or clean database between test runs.
    </standards>
    <locations>
      <location>__tests__/unit/database.test.ts</location>
      <location>__tests__/integration/prisma.test.ts</location>
    </locations>
    <ideas>
      <test ac="AC1">
        <description>Verify Prisma initialization: Check that prisma/schema.prisma file exists, PostgreSQL datasource is configured, DATABASE_URL is documented in .env.example</description>
      </test>
      <test ac="AC2">
        <description>Verify schema definition: Check that User model has all required fields (id, externalId, email, timezone, timestamps) and relationships, Medication model has all required fields (id, userId, name, cronExpression, timestamps) and relationships, ConsumptionHistory model has all required fields (id, medicationId, userId, scheduledTime, consumedAt, timestamps) and relationships, Unique constraints exist: (userId, name) on Medication, (medicationId, scheduledTime) on ConsumptionHistory, Indexes exist: userId on Medication, userId, medicationId, scheduledTime, (userId, scheduledTime) on ConsumptionHistory, All relationships use CASCADE deletes, All date/time fields use DateTime type (maps to TIMESTAMP WITH TIME ZONE), All primary keys use @default(uuid())</description>
      </test>
      <test ac="AC3">
        <description>Verify migration: Check that migration file is created in prisma/migrations/ directory, Run migration and verify tables are created in database (users, medications, consumption_history), Verify Prisma Client is automatically generated after migration</description>
      </test>
      <test ac="AC4">
        <description>Verify Prisma Client generation: Run `npx prisma generate`, Check that Prisma Client is generated in node_modules/.prisma/client, Verify Prisma Client can be imported: `import { PrismaClient } from '@prisma/client'`</description>
      </test>
      <test ac="AC5">
        <description>Verify Prisma Client singleton: Check that lib/prisma/client.ts exists, Verify singleton pattern prevents multiple instances (test in development mode), Verify Prisma Client instance can be imported and used: `import { prisma } from '@/lib/prisma/client'`</description>
      </test>
      <test ac="AC6">
        <description>Verify Prisma Studio: Run `npx prisma studio`, Verify Prisma Studio opens in browser, Verify all tables are visible (users, medications, consumption_history), Verify schema relationships are correctly displayed in Prisma Studio</description>
      </test>
      <test ac="Integration">
        <description>Integration test: Verify database connection works, Verify Prisma Client can query database (test with simple query), Verify database constraints work (test unique constraints, foreign keys), Verify CASCADE deletes work correctly (create user with medications, delete user, verify medications are deleted)</description>
      </test>
    </ideas>
  </tests>
</story-context>

